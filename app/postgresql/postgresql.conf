# PostgreSQL 17.5 Security-Hardened Configuration
# Optimized for MacBook 2012 development environment

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Connection settings
listen_addresses = '*'                  # Listen on all addresses (Docker internal)
port = 5432                            # Standard PostgreSQL port
max_connections = 50                   # Reduced for MacBook 2012 (4-8GB RAM)
superuser_reserved_connections = 3

# Authentication
password_encryption = scram-sha-256    # Modern password hashing
ssl = off                              # Disabled for local development (enable for production)
ssl_prefer_server_ciphers = on
ssl_min_protocol_version = 'TLSv1.2'

#------------------------------------------------------------------------------
# RESOURCE USAGE (MacBook 2012 Optimized)
#------------------------------------------------------------------------------

# Memory settings for 4-8GB system
shared_buffers = 256MB                 # 25% of allocated container memory (1GB)
effective_cache_size = 768MB           # 75% of allocated container memory
work_mem = 8MB                         # Per connection memory (conservative)
maintenance_work_mem = 64MB            # Maintenance operations
max_wal_size = 1GB                     # WAL size limit
min_wal_size = 512MB

# Background writer
bgwriter_delay = 200ms                 # Default
bgwriter_lru_maxpages = 100           # Default
bgwriter_lru_multiplier = 2.0         # Default

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------

# WAL settings
wal_level = replica                    # For replication support
fsync = on                            # Ensure data durability
synchronous_commit = on               # Wait for WAL write
wal_sync_method = fsync               # Sync method
full_page_writes = on                 # Protection against partial page writes
wal_compression = on                  # Compress WAL data (saves space)

# Checkpoints
checkpoint_completion_target = 0.9     # Spread checkpoint I/O
checkpoint_timeout = 10min             # Checkpoint frequency

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Planner settings
random_page_cost = 1.1                # SSD optimization (lower for SSD)
effective_io_concurrency = 100        # Concurrent I/O operations
default_statistics_target = 100       # Default statistics target

# Query execution
enable_hashjoin = on
enable_nestloop = on
enable_seqscan = on
enable_sort = on

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------

# Logging configuration
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# Security logging
log_connections = on
log_disconnections = on
log_hostname = on
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Performance logging
log_statement = 'ddl'                 # Log DDL statements only
log_min_duration_statement = 1000     # Log queries taking > 1 second
log_checkpoints = on
log_lock_waits = on

#------------------------------------------------------------------------------
# RUNTIME STATISTICS
#------------------------------------------------------------------------------

# Statistics collector
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl                   # Track PL/pgSQL functions
track_activity_query_size = 1024

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Statement behavior
search_path = '"$user", public'
default_tablespace = ''
temp_tablespaces = ''

# Locale and formatting
datestyle = 'iso, mdy'
timezone = 'UTC'                       # Use UTC for consistency
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# PERFORMANCE EXTENSIONS
#------------------------------------------------------------------------------

# Shared libraries
shared_preload_libraries = 'pg_stat_statements'  # Query statistics

#------------------------------------------------------------------------------
# SECURITY SETTINGS
#------------------------------------------------------------------------------

# Connection security
ssl_cert_file = 'server.crt'          # SSL certificate (if enabled)
ssl_key_file = 'server.key'           # SSL private key (if enabled)
ssl_ca_file = 'ca.crt'                # Certificate authority (if enabled)

# Authentication timeout
authentication_timeout = 1min         # Timeout for authentication

# Statement timeout (prevent runaway queries)
statement_timeout = 300000             # 5 minutes in milliseconds
idle_in_transaction_session_timeout = 300000  # 5 minutes

#------------------------------------------------------------------------------
# DEVELOPMENT SPECIFIC SETTINGS
#------------------------------------------------------------------------------

# Development optimizations
fsync = on                            # Keep enabled for data safety
full_page_writes = on                 # Keep enabled for crash safety
wal_log_hints = off                   # Disabled for development
hot_standby = off                     # Not needed for single instance

# Memory settings for development
temp_buffers = 8MB                    # Temporary buffer size
shared_preload_libraries = 'pg_stat_statements'

#------------------------------------------------------------------------------
# MACBOOK 2012 SPECIFIC OPTIMIZATIONS
#------------------------------------------------------------------------------

# CPU optimization
max_worker_processes = 4              # Match available CPU cores
max_parallel_workers_per_gather = 2   # Parallel query workers
max_parallel_workers = 4              # Total parallel workers
max_parallel_maintenance_workers = 2  # Maintenance parallel workers

# I/O optimization
effective_io_concurrency = 100        # For SSD (if available)
maintenance_io_concurrency = 10       # Maintenance I/O concurrency

# Memory optimization
huge_pages = try                      # Attempt to use huge pages
temp_file_limit = 1GB                # Limit temporary file size